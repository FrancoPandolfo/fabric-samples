name: Deploy Hyperledger & Java API

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1. Ir a la carpeta raíz del proyecto en el servidor
            cd ./fabric-samples/asset-transfer-basic/maven-API-SiMeDi
            
            # 2. Descargar el código nuevo
            echo "Descargando cambios desde git..."
            git pull origin main
            
            # 3. Dar permisos de ejecución
            chmod +x deploy.sh
            
            # 4. CALCULAR SECUENCIA Y VERSIÓN
            # Hyperledger exige que la secuencia suba estrictamente de 1 en 1.
            # Como tu red pide la secuencia 2, y GitHub va por ejecuciones bajas,
            # usamos el número directo (OFFSET 0) para intentar alinearlos.
            
            OFFSET=0
            SEQ=$(( ${{ github.run_number }} + $OFFSET ))
            VER="1.0.$SEQ"
            
            echo "--- Iniciando Deploy Automático ---"
            echo "GitHub Run: ${{ github.run_number }} | Offset: $OFFSET"
            echo "Target Sequence: $SEQ | Target Version: $VER"
            
            # 5. Ejecutar el script con los valores calculados
            ./deploy.sh "$VER" "$SEQ"